# 🚀 발길맵 Zero-Latency 최적화 기술 문서

초기 코드(Git) 상태에서 현재의 **"즉시 실행(Instant Launch)"** 상태로 만들기 위해 적용된 모든 기술적 변경 사항을 정리한 문서입니다. 이 문서를 따라하면 **어떤 버전의 코드라도 즉시 최적화**할 수 있습니다.

---

## 1. 🌐 네트워크 차단 코딩 (Network non-blocking)
**원인:** 외부 리소스(폰트, CSS, 지도 SDK)가 로드될 때까지 화면이 하얗게 멈추는 현상 (White Screen / Timeout)
**해결:** `rel="preload"` 사용 및 JS 지연 로딩

### `index.html`
**변경 전:**
```html
<link rel="stylesheet" href="styles.css">
<script src="https://dapi.kakao.com/..."></script>
```

**변경 후 (적용 코드):**
```html
<!-- [CSS] Preload 패턴: 로드 중엔 렌더링 차단 안 함 -->
<link rel="preload" href="styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="styles.css"></noscript>

<!-- [JS] Body 맨 끝으로 이동 & defer -->
<script src="https://dapi.kakao.com/..." defer></script>
```

---

## 2. 📱 안드로이드 네이티브 최적화 (Native Warm-up)
**원인:** 앱 아이콘 터치 후 WebView 엔진이 초기화되는 0.3~0.5초 동안 검은 화면 발생
**해결:** `Application` 클래스에서 미리 WebView 생성

### `BalgilApplication.kt` (신규 파일 생성)
**전체 코드:**
```kotlin
package com.balgil.map

import android.app.Application

class BalgilApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        // [Zero-Latency] 앱 시작 시점(Application Start)에 WebView 미리 생성
        // MainActivity가 뜰 때 이미 WebView 인스턴스가 준비되어 있도록 함 (Warm-Up)
        WebViewManager.getOrCreate(this)
    }
}
```

### `AndroidManifest.xml`
**변경 사항:** `android:name` 속성 추가
```xml
<application
    android:name=".BalgilApplication"
    ... >
```

### `MainActivity.kt`
**변경 사항:** `new WebView()` 대신 `getOrCreate()` 사용
```kotlin
// 기존: val webView = WebView(context)
// 변경:
val webView = WebViewManager.getOrCreate(context).apply {
    // 배경색을 테마색(#0A1628)으로 즉시 변경하여 깜빡임 방지
    setBackgroundColor(android.graphics.Color.parseColor("#0A1628"))
    // ... 설정 로직
}
```

---

## 3. 🎨 시각적 동기화 (Visual Unification)
**원인:** 안드로이드 기본 배경(검정) -> 웹뷰 배경(회색) -> 웹 배경(곤색)으로 넘어갈 때 색상이 달라 깜빡임(Flash) 발생
**해결:** 모든 단계의 배경색을 앱 테마색(`#0A1628`)으로 통일

### `colors.xml`
```xml
<color name="window_background">#0A1628</color>
```

### `index.html` (Critical CSS)
```html
<style>
    /* CSS 로드 전에도 즉시 적용 */
    body { background-color: #0A1628; }
</style>
```

---

## 4. ⚡ 실행 순서 병렬화 (Execution Parallelism)
**원인:** DB 초기화 완료 전까지 지도 로딩이 대기함
**해결:** `MapManager.init()`을 최상단으로 이동하여 병렬 실행

### `index.html` (`finishIntro` 함수)
**권한 동의 후 로직:**
```javascript
function finishIntro() {
    // ... Intro 숨김 처리 ...

    // [Critical Fix] 화면이 보이기 시작했을 때 사이즈 갱신 & 지도 초기화
    setTimeout(() => {
        if (window.AppState && !window.AppState.map) {
             window.MapManager?.init();
        } else {
             // 이미 초기화된 경우: 현위치로 이동 & 사이즈 갱신(필수)
             window.MapManager?.getCurrentPosition();
             window.AppState.map.updateSize(); // 빈 화면 방지
        }
    }, 300);
}
```

---

## 🚨 5. 주요 버그 해결 및 주의사항 (Troubleshooting)

### Android Build Cache (변경 사항 적용 안 됨)
- **증상:** 코드를 고쳤는데 앱은 그대로임.
- **해결:** 안드로이드 스튜디오에서 **`Build > Clean Project`** 무조건 실행. 에셋(HTML/JS) 변경은 캐시가 강하게 남습니다.

### Permission Loop (권한 동의 무한 반복)
- **해결:** `localStorage` 체크 로직 확인. (Debug용 강제 설정 코드 제거 필수)

---

## ✅ 개발자 체크리스트 (요약)
1. [x] **`index.html`**: CSS `preload`, JS `defer` 적용.
2. [x] **`index.html`**: Inline Critical CSS(배경색) & `updateSize()` 로직 확인.
3. [x] **`BalgilApplication.kt`**: WebView Warm-up 코드 확인.
4. [x] **`colors.xml`**: `#0A1628` 통일 확인.
5. [x] **`app.js`**: `MapManager.init()` 최상단 이동 확인.
6. [x] **Design**: Intro Icon 70px, Text Color #cccccc, Main Icon 24px 적용 확인.

이상이 **"발길맵 Zero-Latency"** 구현 및 안정화의 최종 내용입니다.
